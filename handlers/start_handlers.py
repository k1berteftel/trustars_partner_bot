from aiogram import Router, F, Bot
from aiogram.filters import CommandStart, CommandObject, Command
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo
from aiogram_dialog import DialogManager, StartMode

from database.action_data_class import DataInteraction
from states.state_groups import InitialSG, adminSG, OwnerSG
from config_data.config import Config, load_config


config: Config = load_config()
start_router = Router()


@start_router.message(CommandStart())
async def start_dialog(msg: Message, dialog_manager: DialogManager, session: DataInteraction):
    await session.add_admin(msg.from_user.id, msg.from_user.username if msg.from_user.username else '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
                            msg.from_user.full_name)
    #await session.update_admin_sub(msg.from_user.id, 1, 'full')
    admin = await session.get_admin(msg.from_user.id)
    if dialog_manager.has_context():
        await dialog_manager.done()
        try:
            await msg.bot.delete_message(chat_id=msg.from_user.id, message_id=msg.message_id - 1)
        except Exception:
            ...
    if not admin.sub:
        web_app = WebAppInfo(url=config.bot.webhook_url)
        keyboard = InlineKeyboardMarkup(
            inline_keyboard=[[InlineKeyboardButton(text='‚≠êÔ∏è–û—Ç–∫—Ä—ã—Ç—å —Ñ—Ä–∞–Ω—à–∏–∑—É!', web_app=web_app)]]
        )
        await msg.answer(
            text='<b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ø–∞—Ä—Ç–Ω–µ—Ä!</b> –ñ–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏ '
                 '–ø–µ—Ä–µ—Ö–æ–¥–∏ –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤–º–µ—Å—Ç–µ —Å –Ω–∞–º–∏!üí∞',
            reply_markup=keyboard)
        return
    if not admin.bot:
        await dialog_manager.start(InitialSG.start, mode=StartMode.RESET_STACK)
        return
    await dialog_manager.start(adminSG.start, mode=StartMode.RESET_STACK)


@start_router.message(Command('help'))
async def send_policy(msg: Message, dialog_manager: DialogManager):
    text = ('<b>–ü–æ–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</b>\n\n–¶–µ–ª—å –º–∞–≥–∞–∑–∏–Ω–∞: –ú–∞–≥–∞–∑–∏–Ω –∑–∞–Ω–∏ –ú–∞ –Ω–æ—Å—ã –ø—Ä–æ–¥–∞–∂–µ–π —Ñ—Ä–∞–Ω—à–∏–∑—ã –±–æ—Ç–∞ '
            '@TrustStarsbot\n\n–ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–±—è–∑–∞–Ω—ã —Å–æ–±–ª—é–¥–∞—Ç—å –≤—Å–µ –ø—Ä–∏–º–µ–Ω–∏–º—ã–µ '
            '–∑–∞–∫–æ–Ω—ã –∏ –ø—Ä–∞–≤–∏–ª–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫—É–ø–ª–µ–Ω–Ω—ã–µ –∑–≤–µ–∑–¥—ã. –ó–∞–ø—Ä–µ—â–µ–Ω—ã –ø–æ–ø—ã—Ç–∫–∏ –æ–±–º–∞–Ω–∞, '
            '–º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ –∏ –¥—Ä—É–≥–∏–µ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è.\n\n–ü—Ä–∏–µ–º –ø–ª–∞—Ç–µ–∂–µ–π: –ú—ã –ø—Ä–∏–Ω–∏–º–∞–µ–º –ø–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω—ã–µ '
            '–º–µ—Ç–æ–¥—ã, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö.\n\n–û–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –º–∞–≥–∞–∑–∏–Ω–∞: '
            '–ú–∞–≥–∞–∑–∏–Ω –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤–∞–º –∫—É–ø–ª–µ–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã.\n\n–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å '
            '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –í—ã –Ω–µ—Å–µ—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–∫–∞–∑–µ —É—Å–ª—É–≥–∏. '
            '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞.\n\n–ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ '
            '–¥–µ–π—Å—Ç–≤–∏—è: –ó–∞–ø—Ä–µ—â–µ–Ω—ã –¥–µ–π—Å—Ç–≤–∏—è, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ, –≤–∫–ª—é—á–∞—è –ø–æ–ø—ã—Ç–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤ –ø–æ—Å–ª–µ '
            '–ø–æ–ª—É—á–µ–Ω–∏—è —É—Å–ª—É–≥–∏.\n\n<b>–ü–æ–ª–∏—Ç–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞</b>\n–£—Å–ª–æ–≤–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞: –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤, '
            '–µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ —Ç–æ–≤–∞—Ä. –ù—É–∂–Ω—ã —Å–∫—Ä–∏–Ω—ã –æ–ø–ª–∞—Ç—ã –∏ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±–æ—Ç–∞.\n\n\n–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞: '
            '–î–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–µ–π —Å–ª—É–∂–±–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–º –¥–∞–Ω–Ω—ã–º. '
            '–ú—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –≤–∞—à –∑–∞–ø—Ä–æ—Å –∏ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–º –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –≤–∞—à—É –∫–∞—Ä—Ç—É/–∫–æ—à–µ–ª–µ–∫.\n\n–°—Ä–æ–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞: '
            '–í—ã –ø–æ–ª—É—á–∏—Ç–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π.\n\n<b>–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</b>\n–°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: '
            '–ú—ã –º–æ–∂–µ–º —Å–æ–±–∏—Ä–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–æ–≤ –∏ —É–ª—É—á—à–µ–Ω–∏—è '
            '—Å–µ—Ä–≤–∏—Å–∞.\n\n–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: –ú—ã –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö.'
            ' –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–æ–≤ –∏ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ —Å –≤–∞–º–∏.\n\n–†–∞–∑–≥–ª–∞—à–µ–Ω–∏–µ'
            ' –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: –ú—ã –Ω–µ —Ä–∞—Å–∫—Ä–æ–µ–º –≤–∞—à—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º, –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º —Å–ª—É—á–∞–µ–≤, –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö '
            '–∑–∞–∫–æ–Ω–æ–º –∏–ª–∏ –≤ —Å–ª—É—á–∞—è—Ö, –∫–æ–≥–¥–∞ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ–¥–∞—á–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ '
            '–ø–ª–∞—Ç–µ–∂–Ω—ã–º —Å–∏—Å—Ç–µ–º–∞–º).\n\n–°–æ–≥–ª–∞—Å–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –ò—Å–ø–æ–ª—å–∑—É—è –Ω–∞—à–∏ —É—Å–ª—É–≥–∏, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –Ω–∞—à–µ–π –ø–æ–ª–∏—Ç–∏–∫–æ–π '
            '–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏.')
    await msg.answer(text)


@start_router.message(Command('admin'))
async def start_owner_dialog(msg: Message, dialog_manager: DialogManager):
    if msg.from_user.id not in config.bot.admin_ids:
        return
    await dialog_manager.start(OwnerSG.start, mode=StartMode.RESET_STACK)

